%% Nonlinear Function T

%% Function
function [g] = Tfxn(y, qBD, qLS, qLF, alLS, alLF, w, local, delta)

%%  Guide 
% *   w has [w0;weps;w0BD;w0LS;w0LF;wLSBD;wLFBD;wBDy;wLSy;wLFy;weLS;weLF,weBD]
y = log(1e-6 + y);

%%  gBD
gBD =  ( local == 3 ).* (  qLS     .*  f(- w(3) - w(6) + (w(13).^2)./2)                              ...
                        + (1-qLS) .* (f(- w(3)        + (w(13).^2)./2))                              ...
                        - qLS     .* (f(  w(3) + w(6) + (w(13).^2)./2))                              ... 
                        - (1-qLS) .*  f(  w(3)        + (w(13).^2)./2))                              ...
    +  ( local == 4 ).* (  qLF    .*  f(- w(3) - w(7) + (w(13).^2)./2)                               ...
                        + (1-qLF) .* (f(- w(3)        + (w(13).^2)./2))                              ...
                        - qLF     .* (f(  w(3) + w(7) + (w(13).^2)./2))                              ...
                    	- (1-qLF) .*  f(  w(3)        + (w(13).^2)./2))                              ...
    -  ( local == 3 | local == 4 | local == 6) .* ( (w(8) -2.*y + 2.*w(1)) ./ (2.*(w(2).^2)) ) .* w(8)  ...
    -  ( local == 3 ) .* ( 1./(w(2).^2) ) .* ( w(9) .*w(8)       .*qLS )                                ...
    -  ( local == 4 ) .* ( 1./(w(2).^2) ) .* ( w(10).*w(8)             .*qLF )                          ...
    -  ( local == 6 ) .* ( 1./(w(2).^2) ) .* ( w(9) .*w(10).*w(8).*qLS .* qLF )                         ...
    -  ( local == 6 ) .* ((qLS       .* qLF      .* f(- w(3) - w(6) - w(7) + (w(13).^2)./2)          ...
                        + qLS       .* (1 - qLF) .* (f(- w(3) - w(6) + (w(13).^2)./2))               ...
                        + (1 - qLS) .* qLF       .* (f(- w(3) - w(7) + (w(13).^2)./2))               ...
                      	- (1 - qLS) .* (1 - qLF) .* f(w(3) + (w(13).^2)./2) )                        ...
                       	- (qLS      .* qLF       .* f(w(3) + w(6) + w(7) + (w(13).^2)./2)            ... 
                       	-  qLS      .* (1 - qLF) .* f(w(3) + w(6) + (w(13).^2)./2)                   ...    
                       	- (1 - qLS) .* qLF       .* f(w(3) + w(7) + (w(13).^2)./2)                   ...
                       	- (1 - qLS) .* (1 - qLF) .* f(w(3) + (w(13).^2)./2) ) );   

%%  gLS
gLS =  ( local == 1 | local == 3 | local == 5 | local == 6) .* ( f(- w(4) - w(14) .* alLS + (w(11) .* w(11)./2)) ...
                                                                - f(w(4) + w(14) .* alLS + (w(11) .* w(11)./2))) ...
    +  ( local == 3  ) .* qBD .* (f(- w(3) - w(6) + (w(13).^2)./2) - f(- w(3) + (w(13).^2)./2) )              ...
    +  ( local == 3  ) .* (1-qBD) .* (f(w(3) + w(6) +(w(13).^2)./2) - f(w(3) + (w(13).^2)./2) )               ...
    +  ( local == 6  ) .* qBD     .* ( qLF       .* f(- w(3) - w(6) - w(7) + (w(13).^2)./2)                      ...
                                     + (1 - qLF) .* f(- w(3) - w(6) + (w(13).^2)./2)                             ...
                                     - qLF       .* f(- w(3) - w(7) + (w(13).^2)./2)                             ...
                                     - (1 - qLF) .* f(- w(3) + (w(13).^2)./2))                                   ...
    +  ( local == 6  ) .* (1-qBD) .* ( qLF       .* f(w(3) + w(6) + w(7) + (w(13).^2)./2)                        ...
                                     + (1 - qLF) .* f(w(3) + w(6) + (w(13).^2)./2)                               ...
                                     - qLF       .* f(w(3) + w(7) + (w(13).^2)./2)                               ...
                                     - (1 - qLF) .* f(w(3) + (w(13).^2)./2) )                                    ...
    -  ( local == 1 | local == 3 | local == 5 | local == 6) .* ( (w(9) - 2.*y + 2.*w(1)) ./ (2.*(w(2).^2)) ) .* w(9)...
    -  ( local == 3 ) .* ( ( w(8).*w(9).*qBD ) ./(w(2).^2) )                                                        ...
    -  ( local == 5 ) .* ( ( w(9).*w(10).*qLF ) ./(w(2).^2) )                                                       ...
    -  ( local == 6 ) .* ( ( w(8).*w(9).*w(10).*qLF.*qBD ) ./(w(2).^2) )                                            ...
    -  ( local == 5 | local == 6 ) .* qLF ./ (2.*delta);

%%  gLF
gLF =  ( local == 2 | local == 4 | local == 5 | local == 6 ) .* ( f(- w(5) - w(15) .* alLF + (w(12) .* w(12)./2))    ...
                                                                - f(w(5) + w(15) .* alLF + (w(12) .* w(12)./2)) )   	...
    +  ( local == 4 | local == 6 ) .* qBD .* (f(- w(3) - w(7) + (w(13).^2)./2) - f(- w(3) + (w(13).^2)./2) )      ...
    +  ( local == 4 | local == 6  ) .* (1-qBD) .* (f(w(3) + w(7) + (w(13).^2)./2) - f(w(3) + (w(13).^2)./2) )     ...
    +  ( local == 6  ) .* qBD     .* ( qLS       .* f(- w(3) - w(6) - w(7) + (w(13).^2)./2)                          ...
                                     + (1 - qLS) .* f(- w(3) - w(7) + (w(13).^2)./2)                                 ...
                                     - qLS       .* f(- w(3) - w(6) + (w(13).^2)./2)                                 ...
                                     - (1 - qLS) .* f(- w(3) + (w(13).^2)./2))                                       ...
    +  ( local == 6  ) .* (1-qBD) .* ( qLS       .* f(w(3) + w(6) + w(7) + (w(13).^2)./2)                            ...
                                     + (1 - qLS) .* f(w(3) + w(7) + (w(13).^2)./2)                                   ...
                                     - qLS       .* f(w(3) + w(6) + (w(13).^2)./2)                                   ...
                                     - (1 - qLS) .* f(w(3) + (w(13).^2)./2) )                                        ...
    -  ( local == 2 | local == 4 | local == 5 | local == 6 ) .* ( (w(10) - 2.*y + 2.*w(1)) ./ (2.*(w(2).^2)) ) .* w(10) ...
    -  ( local == 4 ) .* ( ( w(8).*w(10).*qBD ) ./(w(2).^2) )                                                         	...
    -  ( local == 5 ) .* ( ( w(9).*w(10).*qLS ) ./(w(2).^2) )                                                           ...
    -  ( local == 6 ) .* ( ( w(8).*w(9).*w(10).*qLS.*qBD ) ./(w(2).^2) )                                                ...
    -  ( local == 5 | local == 6 ) .* qLS ./ (2.*delta);

%% Combine
g(:,1) = gBD;
g(:,2) = gLS;
g(:,3) = gLF;

end

